name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc make binutils

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest

    - name: Build Lab 00 (Hello World)
      run: |
        cd labs/00_hello_x86_64
        make clean
        make all

    - name: Test Lab 00
      run: |
        cd labs/00_hello_x86_64
        pytest tests/ -v

    - name: Build Lab 01 (Stack and Calls)
      run: |
        cd labs/01_stack_and_calls_x86_64
        make clean
        make all

    - name: Test Lab 01
      run: |
        cd labs/01_stack_and_calls_x86_64
        pytest tests/ -v

    - name: Build Lab 02 (Control Flow)
      run: |
        cd labs/02_control_flow_x86_64
        make clean
        make all

    - name: Test Lab 02
      run: |
        cd labs/02_control_flow_x86_64
        pytest tests/ -v

    - name: Build Lab 03 (Arrays)
      run: |
        cd labs/03_arrays_x86_64
        make clean
        make all

    - name: Test Lab 03
      run: |
        cd labs/03_arrays_x86_64
        pytest tests/ -v

    - name: Build Lab 04 (Strings)
      run: |
        cd labs/04_strings_x86_64
        make clean
        make all

    - name: Test Lab 04
      run: |
        cd labs/04_strings_x86_64
        pytest tests/ -v

    - name: Build Lab 05 (File I/O)
      run: |
        cd labs/05_file_io_x86_64
        make clean
        make all

    - name: Test Lab 05
      run: |
        cd labs/05_file_io_x86_64
        pytest tests/ -v

    - name: Run all tests
      run: |
        pytest labs/ -v --ignore=labs/_TEMPLATE_LAB

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Run pre-commit hooks
      run: |
        pre-commit run --all-files
